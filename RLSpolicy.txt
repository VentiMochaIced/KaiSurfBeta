-- RLS Policy for 'chronolog' Table
-- Required to meet Requirement 1.1 (Row-Level Security Configuration)

-- 1. Enable RLS on the chronolog table (MUST be done first)
ALTER TABLE chronolog ENABLE ROW LEVEL SECURITY;

-- 2. Define the 'SELECT' (Read) Policy
-- Users can only SELECT records where the user_id linked to the record 
-- matches the authenticated user's ID found via the auth_uid mapping.
-- This requires the 'user' table to be accessible for lookup.
CREATE POLICY "Users can view their own chronolog entries"
    ON chronolog
    FOR SELECT
    TO authenticated
    USING (
        user_id IN (
            SELECT id FROM public."user" WHERE auth_uid = current_setting('request.jwt.claims', true)::json->>'sub'
        )
    );

-- 3. Define the 'INSERT' (Write) Policy
-- Users can only INSERT records for themselves. The application logic 
-- (in kaisurf_multi_platform_test_app.py) handles the user_id insertion, 
-- but this RLS ensures the record matches the token holder.
CREATE POLICY "Users can insert their own chronolog entries"
    ON chronolog
    FOR INSERT
    TO authenticated
    WITH CHECK (
        user_id IN (
            SELECT id FROM public."user" WHERE auth_uid = current_setting('request.jwt.claims', true)::json->>'sub'
        )
    );
